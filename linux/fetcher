#!/usr/bin/lua
if not pcall(function()
pcall(function() require 'luarocks.require' end)
http = require('socket.http')
url = require('socket.url')

http.TIMEOUT = 0.3
http.USERAGENT =  "ibus-sogoupycc"

local py, retry = arg[1] or 'kong bai', 7
py = py:gsub(" ","'"):gsub("[^a-z']", '')

while retry > 0 do
	local ret = http.request('http://web.pinyin.sogou.com/web_ime/get_ajax/'..py..'.key')
	if ret and ret:match('ime_query_res="([^"]*)"') then
		local res = url.unescape(ret:match('ime_query_res="([^"]*)"'))
		if res then
			if res:match('(.-)：') then
				io.write(res:match('(.-)：')) return
			else
				io.write('\n') return
			end
		end
	end
	retry = retry - 1
	http.TIMEOUT = http.TIMEOUT * 1.8
end

-- write smth to keep the pipe open, an ampty line indicates retrieve failure
io.write('\n')

end) then io.write('\n') end
