#!/usr/bin/lua
if not pcall(function()

pcall(function() require 'luarocks.require' end)
http = require('socket.http')
url = require('socket.url')

http.USERAGENT = "ibus-sogoupycc"
keyFile = '/tmp/.sogoucloud-key'


local py, retry, key = arg[1] or 't'
py = py:gsub(" ","+"):gsub("[^a-z']", '')

function refreshKey()
	local ret = http.request('http://web.pinyin.sogou.com/web_ime/patch.php') or ''
	key = ret:match('"(.-)"') or ''
	if #key > 0 then local file = io.open(keyFile, 'w') file:write(key) file:close() end
end

http.TIMEOUT = 0.7
local file = io.open(keyFile, 'r')
if file then key = file:read("*line") or '' file:close() end
for attempt = 1, 7 do if (not key) or (#key == 0) then http.TIMEOUT = http.TIMEOUT * 1.5 refreshKey() else break end end

http.TIMEOUT, retry = 0.5, 6

while retry > 0 do
	local ret = http.request('http://web.pinyin.sogou.com/api/py?key='..key..'&query='..py)
	local res = ret and ret:match('ime_callback%("(.-)"')
	if res then
		res = url.unescape(ret:match('ime_callback%("(.-)"'))
		if res then
			if res:match('(.-)：') then
				io.write(res:match('(.-)：')) return
			else
				io.write('\n') return
			end
		end
	end
	retry = retry - 1
	http.TIMEOUT = http.TIMEOUT * 1.8
end

-- write smth to keep the pipe open, an ampty line indicates retrieve failure
io.write('\n')

-- mark key as invalid (delete it)
os.remove(keyFile)

end) then io.write('\n') end
