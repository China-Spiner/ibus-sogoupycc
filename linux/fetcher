#!/usr/bin/lua
if not pcall(function()

pcall(function() require 'luarocks.require' end)
http = require('socket.http')
url = require('socket.url')

http.USERAGENT = "ibus-sogoupycc"
keyFile = '/tmp/.sogoucloud-key'


local py, timeout, retry, key = arg[1] or 't', arg[2]
py = py:gsub(" ","+"):gsub("[^a-z']", '')

function refreshKey()
	local ret = http.request('http://web.pinyin.sogou.com/web_ime/patch.php') or ''
	key = ret:match('"(.-)"') or ''
	if #key > 0 then local file = io.open(keyFile, 'w') file:write(key) file:close() end
end

if not timeout then http.TIMEOUT, retry = 0.3, 7 else http.TIMEOUT, retry = timeout + 0, 1 end

-- get key
local file = io.open(keyFile, 'r')
if file then key = file:read("*line") or '' file:close() end
for attempt = 1, retry do if (not key) or (#key == 0) then http.TIMEOUT = http.TIMEOUT * 1.5 refreshKey() else break end end

if not timeout then http.TIMEOUT, retry = 0.3, 7 else http.TIMEOUT, retry = timeout + 0, 1 end

for attempt = 1, retry do
	local ret = http.request('http://web.pinyin.sogou.com/api/py?key='..key..'&query='..py)
	local res = ret and ret:match('ime_callback%("(.-)"')
	if res then
		res = url.unescape(ret:match('ime_callback%("(.-)"'))
		if res then
			if res:match('(.-)：') then
				io.write(res:match('(.-)：')) return
			else
				io.write('\n') return
			end
		end
	end
	http.TIMEOUT = http.TIMEOUT * 1.8
end

-- write smth to keep the pipe open, an ampty line indicates retrieve failure
io.write('\n')

-- mark key as invalid (delete it)
os.remove(keyFile)

end) then io.write('\n') end
